<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù‚Ø·Ø© Ø§Ù„Ø±Ø­Ù„Ø©</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; }
    input, button { width: 100%; padding: 10px; margin: 8px 0; }
    #report { white-space: pre-line; margin-top: 20px; }
  </style>
</head>
<body>
  <h2>Ø£Ø¶Ù Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡</h2>
  <input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ" />
  <input id="amount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" />
  <input id="desc" placeholder="ÙˆØµÙ Ø§Ù„Ø´Ø±Ø§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
  <button onclick="addPurchase()">Ø£Ø¶Ù</button>
  <div id="status"></div>
  <div id="report">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±...</div>
  <button onclick="sendWhatsapp()">Ø£Ø±Ø³Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</button>

  <script>
    const SHEET_URL = "Ø¶Ø¹ Ø±Ø§Ø¨Ø· Web App Ù‡Ù†Ø§";

    async function addPurchase() {
      const name = document.getElementById('name').value.trim();
      const amount = parseFloat(document.getElementById('amount').value);
      const desc = document.getElementById('desc').value.trim();

      if (!name) return alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ');
      if (!amount || amount <= 0) return alert('Ø§Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­');

      const res = await fetch(SHEET_URL, {
        method: 'POST',
        body: JSON.stringify({ name, amount, desc })
      });

      const text = await res.text();
      document.getElementById('status').textContent = text;
      loadReport();
      clearForm();
    }

    function clearForm() {
      document.getElementById('name').value = '';
      document.getElementById('amount').value = '';
      document.getElementById('desc').value = '';
    }

    async function loadReport() {
      const res = await fetch(SHEET_URL);
      const data = await res.json();

      if (!data.length) {
        document.getElementById('report').textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.';
        return;
      }

      let total = 0;
      const payments = {};

      data.forEach(row => {
        const name = row[0];
        const amount = parseFloat(row[1]) || 0;
        total += amount;
        payments[name] = (payments[name] || 0) + amount;
      });

      const people = Object.keys(payments);
      const share = total / people.length;

      let report = `ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: ${total.toFixed(2)} Ø±ÙŠØ§Ù„\n\n`;

      people.forEach(p => {
        report += `- ${p}: Ø¯ÙØ¹ ${payments[p].toFixed(2)} Ø±ÙŠØ§Ù„\n`;
      });

      report += `\nğŸ’° Ø§Ù„Ù‚Ø·Ø© Ù„ÙƒÙ„ Ø´Ø®Øµ: ${share.toFixed(2)} Ø±ÙŠØ§Ù„\n\n`;

      let owes = [], gets = [];

      people.forEach(p => {
        const diff = payments[p] - share;
        if (diff > 0) gets.push({ name: p, amount: diff });
        else if (diff < 0) owes.push({ name: p, amount: -diff });
      });

      let i = 0, j = 0;

      while (i < owes.length && j < gets.length) {
        const payAmount = Math.min(owes[i].amount, gets[j].amount);
        report += `- ${owes[i].name} ÙŠØ¯ÙØ¹ ${payAmount.toFixed(2)} Ø±ÙŠØ§Ù„ Ù„Ù€ ${gets[j].name}\n`;

        owes[i].amount -= payAmount;
        gets[j].amount -= payAmount;

        if (owes[i].amount === 0) i++;
        if (gets[j].amount === 0) j++;
      }

      document.getElementById('report').textContent = report;
      window.reportText = report;
    }

    function sendWhatsapp() {
      if (!window.reportText) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚Ø±ÙŠØ± Ù„Ø¥Ø±Ø³Ø§Ù„Ù‡');
      const text = encodeURIComponent(window.reportText);
      window.open(`https://wa.me/?text=${text}`, '_blank');
    }

    loadReport();
  </script>
</body>
</html>
