<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>قطة الرحلة</title>
</head>
<body>
  <h2>إضافة عملية شراء</h2>

  <label>الاسم:</label>
  <input id="name" type="text"><br>

  <label>المبلغ:</label>
  <input id="amount" type="number"><br>

  <label>الوصف:</label>
  <input id="desc" type="text"><br>

  <label>اسم الرحلة:</label>
  <input id="trip" type="text" value="تجربة1"><br><br>

  <button onclick="addPurchase()">أضف</button>

  <h2>سجل العمليات</h2>
  <label>اختر الرحلة:</label>
  <input id="tripSelect" type="text" value="تجربة1" onchange="loadReport()"><br><br>

  <table border="1" id="reportTable">
    <thead>
      <tr>
        <th>الاسم</th>
        <th>المبلغ</th>
        <th>الوصف</th>
        <th>التاريخ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const endpoint = "https://script.google.com/macros/s/AKfycbx2SYsezNXdhxr4KxozzSzx8AgyUGIxRn2lNYW3z3bFlcahQ9LJqSGSE4gS42wXDrajuw/exec";

    async function addPurchase() {
      const name = document.getElementById("name").value;
      const amount = document.getElementById("amount").value;
      const desc = document.getElementById("desc").value;
      const trip = document.getElementById("trip").value;

      try {
        const res = await fetch(endpoint, {
          method: "POST",
          body: JSON.stringify({ name, amount, desc, trip }),
          headers: { "Content-Type": "application/json" },
        });

        const data = await res.json();
        if (data.success) {
          alert("تمت الإضافة بنجاح");
          loadReport();
        } else {
          alert("فشل في الإضافة");
        }
      } catch (err) {
        console.error("خطأ في الإرسال:", err);
        alert("خطأ في الإرسال");
      }
    }

    async function loadReport() {
      const trip = document.getElementById("tripSelect").value;

      try {
        const res = await fetch(`${endpoint}?trip=${encodeURIComponent(trip)}`);
        const data = await res.json();

        const tbody = document.querySelector("#reportTable tbody");
        tbody.innerHTML = "";
        data.forEach(row => {
          const tr = document.createElement("tr");
          row.forEach(cell => {
            const td = document.createElement("td");
            td.textContent = cell;
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("خطأ في تحميل البيانات:", err);
        alert("خطأ في تحميل البيانات");
      }
    }

    // تحميل البيانات عند أول فتح للصفحة
    window.onload = loadReport;
  </script>
</body>
</html>
